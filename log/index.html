<html>
<head>
  <title>Bounding box annotator demo</title>
  <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/themes/smoothness/jquery-ui.css" />
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.js"></script>
  <link rel="stylesheet" 
          href=
"https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.min.css" />
  <script src="bbox_annotator.js"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Sharp:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
  <link rel="stylesheet" href="styles.css">
</head>

<body>
  <!-- bar -->
  <nav id="navigation">
    <a href="#" class="logo">Bounding box annotator<span>+<span></a>
    <ul class="links">
      
      <li class="dropdown"><a href="#" class="trigger-drop">About<i class="arrow"></i></a>
        <ul class="drop">
          <li><a href="#">1.Choose "input method"</a></li>
          <li><a href="#">2.Choose "image"</a></li>
          <li><a href="#">3.Choose "seudo label"(Optional)</a></li>
          <li><a href="#">4.Save it</a></li>
        </ul>
      </li>
      <li class="dropdown"><a href="#" class="trigger-drop">Developers<i class="arrow"></i></a>
        <ul class="drop">
          <li><a href="#">Chang</a></li>
          <li><a href="#">Chang</a></li>
          <li><a href="#">Tsai</a></li>
        </ul>
      </li>
      <li class="dropdown"><a href="#" class="trigger-drop">Contact<i class="arrow"></i></a>
        <ul class="drop">
          <li><a href="#">Email</a></li>
          <li><a href="#">Phone</a></li>
        </ul>
      </li>
    </ul>
  </nav>

  <!-- using instruction -->
  <div>
    <h1>Bounding box annotator demo</h1>
    <p>1.Choose "input method"<br>2.Choose "image"<br>3.Choose "seudo label"(Optional)<br>4.Save it</p>
    <a href="?reload">reload</a>
  </div>
  <!-- label method choose -->
  <div id="bbox_annotator" class="main_area" style="display:inline-block;height: 50px;" ></div>
  <div style="display:inline-block;vertical-align:top;">
    <div>
      <span>Input method: </span>
      <a href="?input=text">text</a> |
      <a href="?input=select">select</a> |
      <a href="?input=fixed">fixed</a> 
     <!--adjust text area here  -->
    </div>
    <div>
      <textarea id="annotation_data" name="annotation" rows="15" cols="50" style="font-family:monospace;" readonly></textarea>
    </div>
    <!-- text area reset button -->
    <div>
      <input id="reset_button" type="reset" />
    </div>
    <!-- choose xml to visualize label -->
    <p>click the button below to choose a seudo label to show.</p>
    <input type="file" name="inputfile" id="inputfile">
    <div>
      <input type="button" id="predict_button" value="predict" />
    </div>
    <pre id="output"></pre>
  </div>

  <!--input url --> 
  <div class='wrapper'>
    <form id='nameForm'>
        
        
        <div id="pics_area">
  
    <div class='form-sub' id="fileid"    onchange="getfilename();">
      <label>
          <img src="icon/upload.png" style="height: 80px;">
          <input type="file" webkitdirectory="true" id="my_test"  onchange="getfilename();" style="display:none">
        </label>
      <button id='subButton' type='button' class="img_start" >Start</button>
      <button id='prev_subButton' type='button'class='img_move'><img src="icon/left_perple.png"height ="80" width="80"  /></button>
      <button id='next_subButton' type='button'class='img_move'><img src="icon/right_perple.png"height ="80" width="80"  /></button> 
    </div>
    </form>
    
    <div>
        <p id='result'></p></div>
    </div>
  <div>


  <p>click the button below to save what you just labeled.</p>
  <input type="button" id="bt" value="Save data to file" onclick="saveFile()" />

  



<!-- link to call python page-->

<p>Check out <a href="http://127.0.0.1:5000/" target="_blank">Training & Predicting</a>.</p>


<!-- <button type="button" onclick="DisplayFilePath();">Display file path</button> -->

<input type="file" webkitdirectory="true" onchange="readmultifiles(this.files)" multiple />
<script type="text/javascript">



var index=0;
var namearray = [];
var xmlarray = [];
var num_of_img=0;
var ori_R = 1;
var file_name;
var ori_width;
var ori_height;
var lines=[];
var line_length;
var ind=1;
var label_list=["5","6"];
var R=1;

function readmultifiles(files) {
  for (file of files) {
    const reader = new FileReader();
    reader.readAsBinaryString(file);
    reader.fileName = file.name;
    if(reader.fileName.endsWith(".xml")){
    reader.onload = (event) => {
      const fileName = event.target.fileName;
      const content = event.currentTarget.result;
      console.log({ fileName, content });
      xmlarray.push(content);
      //alert(xmlarray);
    }
    }
  }
}

document.getElementById('my_test').addEventListener('change', function(event) {	//my_test 為觸發運作的按鈕
	let files = event.target.files;	//選取之目標目錄內的檔案清單
	let listing = document.getElementById('pics_area');	//(透過id)取得要放置圖片的標籤位置

	for(let i=0; i<files.length; i++) {
		let item = document.createElement("img");	//產生圖片標籤
		item.src = files[i].webkitRelativePath;	//設定圖片的來源位置
		item.style.padding = "50px 10px 20px 30px"; //排版用
		// listing.appendChild(item);
    if(item.src.endsWith(".xml")){
      //var fr=new FileReader();
      //fr.readAsText(this.files[ind]);
      //fr.onload=function(){
        //lines.push(fr.result);
        //alert(lines);
      //}
      
      //xmlarray.push(files[i].webkitRelativePath);
      //alert(lines);
      continue;
    }
    namearray.push(files[i].webkitRelativePath);
    num_of_img=num_of_img+1;
	}
  readmultifiles(files);
  alert(namearray);
  alert(xmlarray);
});



document.getElementById('inputfile').addEventListener('change', function() {
    var fr=new FileReader();
    fr.onload=function(){
      lines = fr.result.split('\n');
    }
    fr.readAsText(this.files[0]);
})

function getallname(){
  const fs = require('fs');

  fs.readdir('./', { withFileTypes: true }, (error, files) => {
      if (error) throw error;
      const directoriesInDIrectory = files
          .filter((item) => item.isDirectory())
          .map((item) => item.name);

      console.log(directoriesInDIrectory);
  });
}


function plus(){
  index=index+1;
  if(index > num_of_img-1){
    alert("out of inedx");
    index=index-1;
  }
  // var nameField = document.getElementById('nameField').value;
  var result = document.getElementById('result');
  var file = $("#fileid").val();
  var pos=file.lastIndexOf("\\");
  var nameurl = "img/"+file.substring(pos+1);  
  
  nameurl=namearray[index];
  file_name =  nameurl;
  // if (nameField.length > 1) {
  //     result.textContent = 'url accept. Your image name is: ' + nameField;;
  //     //alert('Username must contain at least 3 characters');
  // } else {
  //     result.textContent = 'You have invaalid url. Try again ';
  //     //alert(nameField);
  // }
  image_element = new Image();
  image_element.src = nameurl;
  var w = image_element.width;
  var h = image_element.height;
  ori_width=w;
  ori_height=h;
  
          var fr=500;
         
          if(w > h){
            if(w>500)
              R=(fr/w);
          }else{
            if(h>500)
              R=(fr/h);
          }
          ori_R = 1/R;
  $(document).ready(function() {
    // Can be one of ['text', 'select', 'fixed']
    var inputMethod = getParameterByName("input");
    // Initialize the bounding-box annotator.
    var annotator = new BBoxAnnotator({
      url: nameurl,
      input_method: inputMethod || "select",
      labels: label_list,
      onchange: function(entries) {
        // Input the text area on change. Use "hidden" input tag unless debugging.
        // <input id="annotation_data" name="annotation_data" type="hidden" />
        // $("#annotation_data").val(JSON.stringify(entries))
        $("#annotation_data").text(JSON.stringify(entries, null, "  "));
      }
    });
     // Initialize the reset button.
  $("#reset_button").click(function(e) {
    annotator.clear_all();
  })
  $("#predict_button").click(function(e) {
    var result = document.getElementById('result');
  var file = $("#fileid").val();
  var pos=file.lastIndexOf("\\");
  var nameurl = "img/"+file.substring(pos+1);  
  
  nameurl=namearray[index];
  file_name =  nameurl;
  // if (nameField.length > 1) {
  //     result.textContent = 'url accept. Your image name is: ' + nameField;;
  //     //alert('Username must contain at least 3 characters');
  // } else {
  //     result.textContent = 'You have invaalid url. Try again ';
  //     //alert(nameField);
  // }
  image_element = new Image();
  image_element.src = nameurl;
  var w = image_element.width;
  var h = image_element.height;
  ori_width=w;
  ori_height=h;
  
          var fr=500;
         
          if(w > h){
            if(w>500)
              R=(fr/w);
          }else{
            if(h>500)
              R=(fr/h);
          }
          ori_R = 1/R;
      lines=xmlarray[index].split('\n');


      for (var i = 0; i <lines.length-1; i++) {
        if(lines[i].search("xmin")!=-1){
          let x0=lines[i].search("<xmin>");
          let x1=lines[i].search("</xmin>");
          let y0=lines[i+1].search("<ymin>");
          let y1=lines[i+1].search("</ymin>");
          let x2=lines[i+2].search("<xmax>");
          let x3=lines[i+2].search("</xmax>");
          let y2=lines[i+3].search("<ymax>");
          let y3=lines[i+3].search("</ymax>");
          let l0=lines[i-5].search("<name>");
          let l1=lines[i-5].search("</name>");
           //
          
          //
          annotator.add_entry({
            "left":parseInt(R*Number(lines[i].substring(x0+6,x1))),
            "top":parseInt(R*Number(lines[i+1].substring(y0+6,y1))),
            "width":parseInt(R*Number(lines[i+2].substring(x2+6,x3)-lines[i].substring(x0+6,x1))),
            "height":parseInt(R*Number(lines[i+3].substring(y2+6,y3)-lines[i+1].substring(y0+6,y1))),
            "label":lines[i-5].substring(l0+6,l1)
          });
        }
      }
      if (annotator.onchange){
        annotator.onchange(annotator.entries);
      }
    })
  });
}
function minus(){
  index=index-1;
  if(index < 0){
    alert("out of inedx");
    index=index+1;
  }
  // var nameField = document.getElementById('nameField').value;
  var result = document.getElementById('result');
  var file = $("#fileid").val();
  var pos=file.lastIndexOf("\\");
  var nameurl = "img/"+file.substring(pos+1);  
  
  nameurl=namearray[index];file_name =  nameurl;

  // if (nameField.length > 1) {
  //     result.textContent = 'url accept. Your image name is: ' + nameField;;
  //     //alert('Username must contain at least 3 characters');
  // } else {
  //     result.textContent = 'You have invaalid url. Try again ';
  //     //alert(nameField);
  // }
  image_element = new Image();
  image_element.src = nameurl;
  var w = image_element.width;
  var h = image_element.height;
  ori_width=w;
  ori_height=h;
  
          var fr=500;
         
          if(w > h){
            if(w>500)
              R=(fr/w);
          }else{
            if(h>500)
              R=(fr/h);
          }
          ori_R = 1/R;
  $(document).ready(function() {
    // Can be one of ['text', 'select', 'fixed']
    var inputMethod = getParameterByName("input");
    // Initialize the bounding-box annotator.
    var annotator = new BBoxAnnotator({
      url: nameurl,
      input_method: inputMethod || "select",
      labels: label_list,
      onchange: function(entries) {
        // Input the text area on change. Use "hidden" input tag unless debugging.
        // <input id="annotation_data" name="annotation_data" type="hidden" />
        // $("#annotation_data").val(JSON.stringify(entries))
        $("#annotation_data").text(JSON.stringify(entries, null, "  "));
      }
    });
     // Initialize the reset button.
  $("#reset_button").click(function(e) {
    annotator.clear_all();
  })
  $("#predict_button").click(function(e) {
    var result = document.getElementById('result');
  var file = $("#fileid").val();
  var pos=file.lastIndexOf("\\");
  var nameurl = "img/"+file.substring(pos+1);  
  
  nameurl=namearray[index];
  file_name =  nameurl;
  // if (nameField.length > 1) {
  //     result.textContent = 'url accept. Your image name is: ' + nameField;;
  //     //alert('Username must contain at least 3 characters');
  // } else {
  //     result.textContent = 'You have invaalid url. Try again ';
  //     //alert(nameField);
  // }
  image_element = new Image();
  image_element.src = nameurl;
  var w = image_element.width;
  var h = image_element.height;
  ori_width=w;
  ori_height=h;
  
          var fr=500;
         
          if(w > h){
            if(w>500)
              R=(fr/w);
          }else{
            if(h>500)
              R=(fr/h);
          }
          ori_R = 1/R;
      lines=xmlarray[index].split('\n');
      

      for (var i = 0; i <lines.length-1; i++) {
        if(lines[i].search("xmin")!=-1){
          let x0=lines[i].search("<xmin>");
          let x1=lines[i].search("</xmin>");
          let y0=lines[i+1].search("<ymin>");
          let y1=lines[i+1].search("</ymin>");
          let x2=lines[i+2].search("<xmax>");
          let x3=lines[i+2].search("</xmax>");
          let y2=lines[i+3].search("<ymax>");
          let y3=lines[i+3].search("</ymax>");
          let l0=lines[i-5].search("<name>");
          let l1=lines[i-5].search("</name>");
           //
           
          //
          annotator.add_entry({
            "left":parseInt(R*Number(lines[i].substring(x0+6,x1))),
            "top":parseInt(R*Number(lines[i+1].substring(y0+6,y1))),
            "width":parseInt(R*Number(lines[i+2].substring(x2+6,x3)-lines[i].substring(x0+6,x1))),
            "height":parseInt(R*Number(lines[i+3].substring(y2+6,y3)-lines[i+1].substring(y0+6,y1))),
            "label":lines[i-5].substring(l0+6,l1)
          });
        }
      }
      if (annotator.onchange){
        annotator.onchange(annotator.entries);
      }
    })
  });
}
//input url finction
function geturl() {
  
  // var nameField = document.getElementById('nameField').value;
  var result = document.getElementById('result');
  var file = $("#fileid").val();
  var pos=file.lastIndexOf("\\");
  var nameurl = "img/"+file.substring(pos);  
  
  nameurl=namearray[index];
  file_name =  nameurl;
 
  image_element = new Image();
  image_element.src = nameurl;
  var w = image_element.width;
  var h = image_element.height;
  ori_width=w;
  ori_height=h;
  
          var fr=500;
         
          if(w > h){
            if(w>500)
              R=(fr/w);
          }else{
            if(h>500)
              R=(fr/h);
          }
          ori_R = 1/R;
  $(document).ready(function() {
    // Can be one of ['text', 'select', 'fixed']
    var inputMethod = getParameterByName("input");
    // Initialize the bounding-box annotator.
    var annotator = new BBoxAnnotator({
      url: nameurl,
      input_method: inputMethod || "select",
      labels: label_list,
      onchange: function(entries) {
        // Input the text area on change. Use "hidden" input tag unless debugging.
        // <input id="annotation_data" name="annotation_data" type="hidden" />
        // $("#annotation_data").val(JSON.stringify(entries))
        $("#annotation_data").text(JSON.stringify(entries, null, "  "));
      }
    });
     // Initialize the reset button.
  $("#reset_button").click(function(e) {
    annotator.clear_all();
  })
  $("#predict_button").click(function(e) {
    var result = document.getElementById('result');
  var file = $("#fileid").val();
  var pos=file.lastIndexOf("\\");
  var nameurl = "img/"+file.substring(pos+1);  
  
  nameurl=namearray[index];
  file_name =  nameurl;
  image_element = new Image();
  image_element.src = nameurl;
  var w = image_element.width;
  var h = image_element.height;
  ori_width=w;
  ori_height=h;
  
          var fr=500;
         
          if(w > h){
            if(w>500)
              R=(fr/w);
          }else{
            if(h>500)
              R=(fr/h);
          }
          ori_R = 1/R;
      lines=xmlarray[index].split('\n');
      
      for (var i = 0; i <lines.length-1; i++) {
        if(lines[i].search("xmin")!=-1){
          let x0=lines[i].search("<xmin>");
          let x1=lines[i].search("</xmin>");
          let y0=lines[i+1].search("<ymin>");
          let y1=lines[i+1].search("</ymin>");
          let x2=lines[i+2].search("<xmax>");
          let x3=lines[i+2].search("</xmax>");
          let y2=lines[i+3].search("<ymax>");
          let y3=lines[i+3].search("</ymax>");
          let l0=lines[i-5].search("<name>");
          let l1=lines[i-5].search("</name>");
          //
          
          //
          annotator.add_entry({
            "left":parseInt(R*Number(lines[i].substring(x0+6,x1))),
            "top":parseInt(R*Number(lines[i+1].substring(y0+6,y1))),
            "width":parseInt(R*Number(lines[i+2].substring(x2+6,x3)-lines[i].substring(x0+6,x1))),
            "height":parseInt(R*Number(lines[i+3].substring(y2+6,y3)-lines[i+1].substring(y0+6,y1))),
            "label":lines[i-5].substring(l0+6,l1)
          });
        }
      }
      if (annotator.onchange){
        annotator.onchange(annotator.entries);
      }
    })
  });
  

}
var subButton = document.getElementById('subButton');
subButton.addEventListener('click', geturl, false); 

var next_subButton = document.getElementById('next_subButton');
next_subButton.addEventListener('click', plus, false); 

var prev_subButton = document.getElementById('prev_subButton');
prev_subButton.addEventListener('click', minus, false); 



//initialize 
function getParameterByName(name) {
  var match = RegExp('[?&]' + name + '=([^&]*)').exec(window.location.search);
  return match && decodeURIComponent(match[1].replace(/\+/g, ' '));
}
$(document).ready(function() {
  // Can be one of ['text', 'select', 'fixed']
  var inputMethod = getParameterByName("input");
  // Initialize the bounding-box annotator.
  var annotator = new BBoxAnnotator({
    url: "C:\fakepath\1Small.jpeg",
    input_method: inputMethod || "select",
    labels: label_list,
    x1:50,y1:100,x2:50,y2:100,
    onchange: function(entries) {
      // Input the text area on change. Use "hidden" input tag unless debugging.
      // <input id="annotation_data" name="annotation_data" type="hidden" />
      // $("#annotation_data").val(JSON.stringify(entries))
      $("#annotation_data").text(JSON.stringify(entries, null, "  "));
    }
  });
  // Initialize the reset button.
  $("#reset_button").click(function(e) {
    annotator.clear_all();
  })
  // $("#predict_button").click(function(e) {
  //     alert(lines.length);
  //     alert("initial phase");
  //     for (var i = 0; i <(lines.length-1)/5; i++) {
  //       annotator.add_entry({
  //         "top":Number(lines[i*5]),
  //         "left":Number(lines[i*5+1]),
  //         "width":Number(lines[i*5+2]),
  //         "height":Number(lines[i*5+3]),
  //         "label":lines[i*5+4]
  //       });
  //     }
      
  //     if (annotator.onchange){
  //       annotator.onchange(annotator.entries);
  //     }
  //   })
});

let saveFile = () => {
   
    
      // Get the data from each element on the form.
    const name = document.getElementById('annotation_data');
    
      
      // This variable stores all the data.
      let data = 
      ' filename = ' + file_name + ' \r\n '
      +'w_real = ' + ori_width + ' \r\n '
      +'h_real = ' + ori_height + ' \r\n '
      +'R = ' + ori_R +' \r\n '
      + name.value + ' \r\n ';
      
      // Convert the text to BLOB.
      const textToBLOB = new Blob([data], { type: 'text/plain' });
      const sFileName =file_name+'.txt';	   // The file to save the data.

      let newLink = document.createElement("a");
      newLink.download = sFileName;

      if (window.webkitURL != null) {
          newLink.href = window.webkitURL.createObjectURL(textToBLOB);
      }
      else {
          newLink.href = window.URL.createObjectURL(textToBLOB);
          newLink.style.display = "none";
          document.body.appendChild(newLink);
      }

      newLink.click(); 
  }



  
</script>

</body>
</html>